name: Release

on:
  release:
    types: [published]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  # ──────────────────────────────────────────────
  # Full CI gate before publishing
  # ──────────────────────────────────────────────
  ci:
    name: CI Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsecret-1-dev build-essential python3

      - name: Install npm dependencies
        run: npm ci
        env:
          HUSKY: 0

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

      - name: Verify CLI loads
        run: node bin/platypus.js --help

  # ──────────────────────────────────────────────
  # Publish to npm
  # ──────────────────────────────────────────────
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: ci
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsecret-1-dev build-essential python3

      - name: Install dependencies
        run: npm ci
        env:
          HUSKY: 0

      - name: Build
        run: npm run build

      - name: Publish
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify published package
        run: |
          sleep 10
          PUBLISHED_VERSION=$(npm view platypus-cli version 2>/dev/null || echo "unknown")
          EXPECTED_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "Published: $PUBLISHED_VERSION | Expected: $EXPECTED_VERSION"
          if [ "$PUBLISHED_VERSION" = "$EXPECTED_VERSION" ]; then
            echo "✅ Package published successfully"
          else
            echo "⚠️ Version mismatch — registry may need time to propagate"
          fi
